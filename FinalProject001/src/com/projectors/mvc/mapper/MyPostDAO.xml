<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.projectors.mvc.IMyPostDAO">

	<!-- 샘플 <select resultType="com.projectors.mvc.RecruitDTO" id="countRecruitMember"> 
		SELECT SUM(COUNTALL) AS COUNTALL , SUM(COUNTPOS) AS COUNTPOS , RECRUITNO 
		FROM RECRUITPOSITIONVIEW WHERE RECRUITNO LIKE '%' || #{recruitNo } GROUP 
		BY RECRUITNO </select> -->

	<!-- 현재 모집 공고 정보 가져오기 -->
	<select id="presentRecruit"
		resultType="com.projectors.mvc.MyPostDTO">
		SELECT REC.RECRUIT_NO AS RECRUITNO, REC.TITLE AS RECRUITNAME, REC.PRJ_START AS PRJSTART
		, REC.PRJ_END AS PRJEND
		, REC.CREATED_DATE AS CREATEDDATE, (REC.CREATED_DATE + 13 ) AS DEADLINE
		FROM RECRUIT REC
		WHERE REC.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14 AND
		REC.RECRUIT_NO NOT IN (SELECT RECRUIT_NO FROM PROJECT)
	</select>

	<!-- 현재 올려놓은 모집 공고가 있는지  -->
	<select id="presentCheck" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM RECRUIT REC
		WHERE REC.PIN_NO=#{pinNo}
		AND REC.CREATED_DATE >
		SYSDATE-14 AND REC.RECRUIT_NO NOT IN (SELECT RECRUIT_NO FROM PROJECT)
	</select>

	<select id="checkPresentNone" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM APPLY AP
		LEFT
		JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO = RP.RECRUIT_POS_NO
		LEFT
		JOIN
		RECRUIT REC ON REC.RECRUIT_NO = RP.RECRUIT_NO
		LEFT JOIN USERS US ON
		AP.PIN_NO = US.PIN_NO
		LEFT JOIN POSITION POS ON RP.POS_NO = POS.POS_NO
		WHERE REC.RECRUIT_NO=#{recruitNo} AND AP.CK_DATE IS NULL AND
		AP.APPLY_NO NOT IN (SELECT APPLY_NO FROM FIRST_CK)
	</select>

	<select id="presentNone" resultType="com.projectors.mvc.MyPostDTO">
	SELECT AP.APPLY_NO AS APPLYNO, AP.PIN_NO AS PINNO, RP.POS_NO AS POSNO,
	US.NICKNAME AS NICKNAME, POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS
	RECRUITNO, AP.CK_DATE AS CKDATE, RP.RECRUIT_POS_NO AS RECRUITPOSNO
	FROM APPLY AP
	LEFT JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO = RP.RECRUIT_POS_NO
	LEFT JOIN RECRUIT REC ON REC.RECRUIT_NO = RP.RECRUIT_NO
	LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
	LEFT JOIN POSITION POS ON RP.POS_NO = POS.POS_NO
	WHERE REC.RECRUIT_NO=#{recruitNo} AND AP.CK_DATE IS NULL AND AP.APPLY_NO NOT IN
	(SELECT APPLY_NO FROM FIRST_CK)
	</select>



	<select id="checkPresentX" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS RP ON
		AP.RECRUIT_POS_NO =
		RP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON
		REC.RECRUIT_NO =
		RP.RECRUIT_NO
		LEFT JOIN USERS US ON AP.PIN_NO =
		US.PIN_NO
		LEFT JOIN
		POSITION POS ON RP.POS_NO = POS.POS_NO
		WHERE
		REC.RECRUIT_NO=#{recruitNo} AND AP.CK_DATE IS NOT NULL AND AP.APPLY_NO
		NOT IN
		(SELECT APPLY_NO FROM FIRST_CK)
	</select>


	<select id="presentX" resultType="com.projectors.mvc.MyPostDTO">
		SELECT AP.APPLY_NO AS APPLYNO, AP.PIN_NO AS PINNO, RP.POS_NO AS POSNO,
		US.NICKNAME AS NICKNAME, POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS
		RECRUITNO, AP.CK_DATE AS CKDATE, RP.RECRUIT_POS_NO AS RECRUITPOSNO  
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO = RP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REC.RECRUIT_NO = RP.RECRUIT_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		LEFT JOIN POSITION POS ON RP.POS_NO = POS.POS_NO
		WHERE REC.RECRUIT_NO=#{recruitNo} AND AP.CK_DATE IS NOT NULL AND AP.APPLY_NO NOT IN
		(SELECT APPLY_NO FROM FIRST_CK)
	</select>

	<select id="checkPresentO" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO = RP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REC.RECRUIT_NO = RP.RECRUIT_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		LEFT JOIN POSITION POS ON RP.POS_NO = POS.POS_NO
		WHERE REC.RECRUIT_NO=#{recruitNo} AND AP.APPLY_NO IN (SELECT APPLY_NO FROM FIRST_CK)
	</select>

	<select id="presentO" resultType="com.projectors.mvc.MyPostDTO">
		SELECT AP.APPLY_NO AS APPLYNO, AP.PIN_NO AS PINNO, RP.POS_NO AS POSNO, US.NICKNAME AS NICKNAME,
		POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS RECRUITNO, AP.CK_DATE AS	CKDATE, RP.RECRUIT_POS_NO AS RECRUITPOSNO
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO =
		RP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REC.RECRUIT_NO =
		RP.RECRUIT_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		LEFT JOIN
		POSITION POS ON RP.POS_NO = POS.POS_NO
		WHERE
		REC.RECRUIT_NO=#{recruitNo} AND AP.APPLY_NO IN (SELECT APPLY_NO FROM
		FIRST_CK)
	</select>

	<update id="readApply">
		UPDATE APPLY
		SET CK_DATE = SYSDATE
		WHERE APPLY_NO=#{applyNo}
	</update>


	<select id="fullCheckRecPos" resultType="java.lang.Integer">
		SELECT COUNT(RP.RECRUIT_POS_NO) AS COUNT
		FROM RECRUIT_POS RP
		LEFT JOIN POSITION POS ON RP.POS_NO =  POS.POS_NO
		WHERE RP.RECRUIT_POS_NO =#{recruitPosNo} AND RECRUIT_POS_NO IN (SELECT RP.RECRUIT_POS_NO
                                              				 FROM FIRST_CK FS
                                              				 LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
                                              				 LEFT JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO = RP.RECRUIT_POS_NO
                                              				 LEFT JOIN POSITION POS ON RP.POS_NO = POS.POS_NO)	
	</select>

	<select id="postionCount" resultType="com.projectors.mvc.MyPostDTO">
			SELECT SUM(COUNTALL) AS COUNTALL
		     , SUM(COUNTPOS) AS COUNTPOS
		     , POSNAME
			FROM RECRUITPOSITIONVIEW 
			WHERE RECRUITNO = #{recruitNo}
			GROUP BY POSNAME
	</select>



	<insert id="firstCk">
		INSERT INTO FIRST_CK
		(FIRST_CK_NO
		, APPLY_NO
		, PASS_DATE)
		VALUES
		( 'FS'||FIRSTCKSEQ.NEXTVAL
		, #{applyNo}
		, SYSDATE)
	</insert>
	
	
	
	<!-- 공고 전제 모집 총원 구하는 메소드 -->
	<select id="recruitCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM RECRUIT_POS RP
		WHERE RP.RECRUIT_NO=#{recruitNo}
	</select>
	
	
	<!-- 1차 합격자수 구하는 메소드  -->
	<select id="firstCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM FIRST_CK FS
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS RP ON AP.RECRUIT_POS_NO = RP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON RP.RECRUIT_NO = REC.RECRUIT_NO
		WHERE REC.RECRUIT_NO=#{recruitNo}
	</select>
		
	<insert id="finalCk">
		INSERT INTO FINAL
		VALUES
		( 'FN'||TO_CHAR(FINALNOSEQ.NEXTVAL)
		 , (SELECT FIRST_CK_NO
		    FROM FIRST_CK
		    WHERE APPLY_NO=#{applyNo})
		 , SYSDATE )
	</insert>

	<select id="finalCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM FINAL FN
		LEFT JOIN FIRST_CK FS ON FN.FIRST_CK_NO = FS.FIRST_CK_NO
		LEFT JOIN APPLY AP ON FS.APPLY_NO =  AP.APPLY_NO
		LEFT JOIN RECRUIT_POS RP ON RP.RECRUIT_POS_NO = AP.RECRUIT_POS_NO
		WHERE RP.RECRUIT_NO=#{recruitNo}
	</select>
	

	<insert id="insertProject">
		INSERT INTO PROJECT
		VALUES
		( 'PJ'||TO_CHAR(PROJECTNOSEQ.NEXTVAL)
		, #{recruitNo}
		, SYSDATE)
	</insert>
	
	<!--▼▼▼ 나의 과거 모집 공고 관련 쿼리문  -->
	<select id="checkPastPost" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM RECRUIT
		WHERE PIN_NO=#{pinNo} AND SYSDATE-14 >= CREATED_DATE
	</select>
	
	
	<select id="myPastPost" resultType="com.projectors.mvc.MyPostDTO">
		SELECT REC.RECRUIT_NO AS RECRUITNO, REC.TITLE AS RECRUITNAME, REC.CREATED_DATE AS CREATEDDATE, REC.PRJ_START AS PRJSTART, REC.PRJ_END AS PRJEND, COUNT(FS.FIRST_CK_NO) AS FIRSTCKCOUNT, COUNT(REP.RECRUIT_POS_NO) AS TOTALCOUNT 
        ,PRJ.PRJ_NO AS PRJNO
		FROM RECRUIT REC
		LEFT JOIN RECRUIT_POS REP ON REC.RECRUIT_NO = REP.RECRUIT_NO
		LEFT JOIN APPLY AP ON REP.RECRUIT_POS_NO = AP.RECRUIT_POS_NO
		LEFT JOIN FIRST_CK FS ON AP.APPLY_NO = FS.APPLY_NO
		LEFT JOIN PROJECT PRJ ON REC.RECRUIT_NO = PRJ.RECRUIT_NO
		WHERE REC.PIN_NO=#{pinNo} AND SYSDATE-14 >= REC.CREATED_DATE
		GROUP BY REC.TITLE, REC.CREATED_DATE,REC.RECRUIT_NO, REC.PRJ_START, REC.PRJ_END, PRJ.PRJ_NO
	</select>
	 
	

</mapper>